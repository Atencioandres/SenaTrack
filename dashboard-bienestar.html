<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Personal de Bienestar - SenaTrack</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="dashboard">
    <div class="dashboard-header">
        <div class="dashboard-nav">
            <a href="dashboard-bienestar.html" class="logo">
                <!-- Reemplazado logo de texto por imagen real -->
                <img src="img\LogoST.png" alt="SenaTrack Logo" style="height: 50px; width: auto;">
                <span>SenaTrack</span>
            </a>
            <div class="user-info">
                <span id="nombreUsuario"></span>
                <div class="user-avatar" id="avatarUsuario"></div>
                <button class="btn btn-secondary" onclick="window.location.href='perfil.html'" style="margin-right: 0.5rem;">Mi Perfil</button>
                <button class="btn btn-secondary" onclick="cerrarSesion()">Cerrar Sesi贸n</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Panel de Personal de Bienestar</h1>
        <p style="color: var(--color-muted-foreground); margin-bottom: 2rem;">Gestiona comparendos y genera informes</p>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Comparendos Registrados</div>
                <div class="stat-value" id="totalComparendos">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Este Mes</div>
                <div class="stat-value" id="comparendosMes">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Aprendices Afectados</div>
                <div class="stat-value" id="aprendicesAfectados">0</div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title">Registrar Nuevo Comparendo</h2>
            </div>
            <form id="formComparendo" enctype="multipart/form-data">
                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">Aprendiz</label>
                        <select class="form-select" id="aprendizSelect" required>
                            <option value="">Seleccione un aprendiz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Informe</label>
                        <select class="form-select" id="tipoInforme" required>
                            <option value="">Seleccione un tipo</option>
                            <option value="Conducta">Conducta</option>
                            <option value="Asistencia">Asistencia</option>
                            <option value="Rendimiento">Rendimiento</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci贸n del Comparendo</label>
                    <textarea class="form-textarea" id="descripcion" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-input" id="fecha" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Evidencia (Opcional)</label>
                    <input type="file" class="form-input" id="evidencia" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx">
                    <p style="color: var(--color-muted-foreground); font-size: 0.875rem; margin-top: 0.5rem;">
                        Formatos permitidos: JPG, PNG, GIF, PDF, DOC, DOCX (M谩ximo 5MB)
                    </p>
                    <div id="previewEvidencia" style="margin-top: 1rem;"></div>
                </div>
                <button type="submit" class="btn btn-primary">Registrar Comparendo</button>
            </form>
        </div>

        <div style="margin-bottom: 2rem;">
            <button class="btn btn-primary" onclick="window.location.href='informes.html'" style="width: 100%; padding: 1rem; font-size: 1.125rem;">
                 Generar Informes
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Comparendos Registrados</h2>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Aprendiz</th>
                            <th>Tipo</th>
                            <th>Descripci贸n</th>
                            <th>Evidencia</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaComparendos">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Verificar autenticaci贸n
        verificarAutenticacion('bienestar');
        
        // Cargar informaci贸n del usuario
        const usuarioActual = JSON.parse(localStorage.getItem('usuarioActual'));
        document.getElementById('nombreUsuario').textContent = usuarioActual.nombre;
        document.getElementById('avatarUsuario').textContent = usuarioActual.nombre.charAt(0).toUpperCase();
        
        // Establecer fecha actual
        document.getElementById('fecha').valueAsDate = new Date();
        
        // Cargar datos
        cargarAprendices();
        cargarEstadisticas();
        cargarComparendos();
        
        document.getElementById('evidencia').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('previewEvidencia');
            
            if (file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const fileType = file.type;
                
                if (fileType.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `
                            <div style="padding: 1rem; background: var(--color-muted); border-radius: 0.5rem;">
                                <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 0.5rem;">
                                <p style="margin-top: 0.5rem; font-size: 0.875rem;">${file.name} (${fileSize} MB)</p>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = `
                        <div style="padding: 1rem; background: var(--color-muted); border-radius: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;"></div>
                            <div style="flex: 1;">
                                <p style="font-weight: 600; margin-bottom: 0.25rem;">${file.name}</p>
                                <p style="color: var(--color-muted-foreground); font-size: 0.875rem;">${fileSize} MB</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                preview.innerHTML = '';
            }
        });
        
        function cargarAprendices() {
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const aprendices = usuarios.filter(u => u.tipoUsuario === 'aprendiz');
            
            const select = document.getElementById('aprendizSelect');
            select.innerHTML = '<option value="">Seleccione un aprendiz</option>' +
                aprendices.map(a => `<option value="${a.id}">${a.nombre} - Ficha ${a.ficha || 'N/A'}</option>`).join('');
        }
        
        function cargarEstadisticas() {
            const comparendos = JSON.parse(localStorage.getItem('comparendos') || '[]');
            
            document.getElementById('totalComparendos').textContent = comparendos.length;
            
            const mesActual = new Date().getMonth();
            const comparendosMes = comparendos.filter(c => {
                const fechaComparendo = new Date(c.fecha);
                return fechaComparendo.getMonth() === mesActual;
            });
            document.getElementById('comparendosMes').textContent = comparendosMes.length;
            
            const aprendicesUnicos = new Set(comparendos.map(c => c.idAprendiz));
            document.getElementById('aprendicesAfectados').textContent = aprendicesUnicos.size;
        }
        
        function cargarComparendos() {
            const comparendos = JSON.parse(localStorage.getItem('comparendos') || '[]');
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const tbody = document.getElementById('tablaComparendos');
            
            tbody.innerHTML = comparendos.map(comparendo => {
                const aprendiz = usuarios.find(u => u.id === comparendo.idAprendiz);
                const fecha = new Date(comparendo.fecha).toLocaleDateString('es-ES');
                
                let evidenciaHTML = '<span style="color: var(--color-muted-foreground);">Sin evidencia</span>';
                if (comparendo.evidencia) {
                    evidenciaHTML = `<a href="${comparendo.evidencia}" target="_blank" style="color: var(--color-primary);">Ver evidencia</a>`;
                }
                
                return `
                    <tr>
                        <td>${fecha}</td>
                        <td>${aprendiz ? aprendiz.nombre : 'Desconocido'}</td>
                        <td><span class="badge badge-warning">${comparendo.tipo}</span></td>
                        <td>${comparendo.descripcion}</td>
                        <td>${evidenciaHTML}</td>
                        <td>
                            <button class="btn btn-destructive" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="eliminarComparendo('${comparendo.id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        document.getElementById('formComparendo').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('evidencia');
            let evidenciaURL = null;
            
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    evidenciaURL = e.target.result;
                    guardarComparendo(evidenciaURL);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                guardarComparendo(null);
            }
        });
        
        function guardarComparendo(evidenciaURL) {
            const nuevoComparendo = {
                id: Date.now().toString(),
                idAprendiz: document.getElementById('aprendizSelect').value,
                tipo: document.getElementById('tipoInforme').value,
                descripcion: document.getElementById('descripcion').value,
                fecha: document.getElementById('fecha').value,
                evidencia: evidenciaURL,
                fechaRegistro: new Date().toISOString()
            };
            
            let comparendos = JSON.parse(localStorage.getItem('comparendos') || '[]');
            comparendos.push(nuevoComparendo);
            localStorage.setItem('comparendos', JSON.stringify(comparendos));
            
            alert('Comparendo registrado exitosamente');
            document.getElementById('formComparendo').reset();
            document.getElementById('previewEvidencia').innerHTML = '';
            document.getElementById('fecha').valueAsDate = new Date();
            cargarEstadisticas();
            cargarComparendos();
        }
        
        function eliminarComparendo(id) {
            if (confirm('驴Est谩 seguro de eliminar este comparendo?')) {
                let comparendos = JSON.parse(localStorage.getItem('comparendos') || '[]');
                comparendos = comparendos.filter(c => c.id !== id);
                localStorage.setItem('comparendos', JSON.stringify(comparendos));
                cargarEstadisticas();
                cargarComparendos();
                alert('Comparendo eliminado exitosamente');
            }
        }
    </script>
</body>
</html>
