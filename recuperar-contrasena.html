<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contrase√±a - SenaTrack</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <div class="logo-circle">
                    <span>ST</span>
                </div>
            </div>
            <h1>Recuperar Contrase√±a</h1>
            <p class="auth-subtitle">Ingresa tu correo electr√≥nico para recibir un c√≥digo de verificaci√≥n</p>

            <!-- Paso 1: Ingresar correo electr√≥nico -->
            <div id="step1" class="recovery-step">
                <form id="emailForm">
                    <div class="form-group">
                        <label for="correo">Correo Electr√≥nico</label>
                        <div class="input-with-icon">
                            <span class="input-icon">üìß</span>
                            <input type="email" id="correo" name="correo" required 
                                   placeholder="ejemplo@sena.edu.co">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Enviar C√≥digo al Correo</button>
                </form>
            </div>

            <!-- Paso 2: Ingresar c√≥digo de verificaci√≥n -->
            <div id="step2" class="recovery-step" style="display: none;">
                <div class="success-message">
                    <div class="success-icon">‚úì</div>
                    <p>Se ha enviado un c√≥digo de verificaci√≥n a tu correo electr√≥nico</p>
                    <p class="email-display" id="emailDisplay"></p>
                </div>
                <form id="codeForm">
                    <div class="form-group">
                        <label for="codigo">C√≥digo de Verificaci√≥n</label>
                        <div class="input-with-icon">
                            <span class="input-icon">üîë</span>
                            <input type="text" id="codigo" name="codigo" required 
                                   placeholder="Ingresa el c√≥digo de 6 d√≠gitos" maxlength="6">
                        </div>
                        <small>El c√≥digo expira en 15 minutos</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Verificar C√≥digo</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Volver</button>
                </form>
            </div>

            <!-- Paso 3: Cambiar contrase√±a -->
            <div id="step3" class="recovery-step" style="display: none;">
                <div class="success-message">
                    <div class="success-icon">‚úì</div>
                    <p>C√≥digo verificado correctamente</p>
                </div>
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="nuevaContrasena">Nueva Contrase√±a</label>
                        <div class="input-with-icon">
                            <span class="input-icon">üîí</span>
                            <input type="password" id="nuevaContrasena" name="nuevaContrasena" required 
                                   minlength="6" placeholder="M√≠nimo 6 caracteres">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirmarContrasena">Confirmar Contrase√±a</label>
                        <div class="input-with-icon">
                            <span class="input-icon">üîí</span>
                            <input type="password" id="confirmarContrasena" name="confirmarContrasena" required 
                                   minlength="6" placeholder="Repite la contrase√±a">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Cambiar Contrase√±a</button>
                </form>
            </div>

            <div class="auth-footer">
                <a href="login.html">Volver al inicio de sesi√≥n</a>
            </div>
        </div>
    </div>

    <script>
        console.log("[v0] P√°gina de recuperaci√≥n cargada");
        
        let currentEmail = null;
        let currentCode = null;

        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("[v0] Formulario de email enviado");
            
            const correo = document.getElementById('correo').value;
            console.log("[v0] Correo ingresado:", correo);

            try {
                console.log("[v0] Enviando solicitud a api/enviar-codigo.php");
                const response = await fetch('api/enviar-codigo.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ correo })
                });

                console.log("[v0] Respuesta recibida:", response.status);
                const data = await response.json();
                console.log("[v0] Datos recibidos:", data);

                if (data.success) {
                    currentEmail = correo;
                    document.getElementById('emailDisplay').textContent = correo;
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                    
                    // Mostrar el c√≥digo en consola (solo para desarrollo)
                    if (data.codigo_debug) {
                        console.log('[v0] C√≥digo de verificaci√≥n:', data.codigo_debug);
                        alert('DESARROLLO: Tu c√≥digo es ' + data.codigo_debug + ' (revisa la consola)');
                    }
                } else {
                    console.error("[v0] Error en respuesta:", data.message);
                    alert(data.message || 'Error al enviar c√≥digo');
                }
            } catch (error) {
                console.error('[v0] Error al enviar c√≥digo:', error);
                alert('Error de conexi√≥n. Verifica que Apache y MySQL est√©n corriendo en XAMPP.');
            }
        });

        document.getElementById('codeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("[v0] Formulario de c√≥digo enviado");
            
            const codigo = document.getElementById('codigo').value;
            console.log("[v0] C√≥digo ingresado:", codigo);

            try {
                console.log("[v0] Verificando c√≥digo...");
                const response = await fetch('api/verificar-codigo.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ correo: currentEmail, codigo })
                });

                console.log("[v0] Respuesta recibida:", response.status);
                const data = await response.json();
                console.log("[v0] Datos recibidos:", data);

                if (data.success) {
                    currentCode = codigo;
                    document.getElementById('step2').style.display = 'none';
                    document.getElementById('step3').style.display = 'block';
                } else {
                    console.error("[v0] Error:", data.message);
                    alert(data.message || 'C√≥digo incorrecto o expirado');
                }
            } catch (error) {
                console.error('[v0] Error al verificar c√≥digo:', error);
                alert('Error de conexi√≥n');
            }
        });

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("[v0] Formulario de contrase√±a enviado");
            
            const nuevaContrasena = document.getElementById('nuevaContrasena').value;
            const confirmar = document.getElementById('confirmarContrasena').value;

            if (nuevaContrasena !== confirmar) {
                alert('Las contrase√±as no coinciden');
                return;
            }

            try {
                console.log("[v0] Cambiando contrase√±a...");
                const response = await fetch('api/cambiar-contrasena.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        correo: currentEmail,
                        codigo: currentCode,
                        nueva_contrasena: nuevaContrasena
                    })
                });

                console.log("[v0] Respuesta recibida:", response.status);
                const data = await response.json();
                console.log("[v0] Datos recibidos:", data);

                if (data.success) {
                    alert('¬°Contrase√±a cambiada exitosamente!');
                    window.location.href = 'login.html';
                } else {
                    console.error("[v0] Error:", data.message);
                    alert(data.message || 'Error al cambiar contrase√±a');
                }
            } catch (error) {
                console.error('[v0] Error al cambiar contrase√±a:', error);
                alert('Error de conexi√≥n');
            }
        });

        function resetForm() {
            console.log("[v0] Reiniciando formulario");
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
            document.getElementById('emailForm').reset();
            currentEmail = null;
            currentCode = null;
        }
    </script>
</body>
</html>
